<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>G√§stebuch</title>

<style>
  :root{
    --agave:#2e5d50;
    --gold:#c7a96b;
    --ink:#1d2b27;
    --bg1:#e7efe9;
    --bg2:#f4f1ea;
    --card:#ffffff;
    --shadow: 0 18px 40px rgba(0,0,0,.10);
  }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    min-height:100vh;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    color:var(--ink);
    overflow-x:hidden;
  }

  header{
    position: sticky;
    top:0;
    z-index:10;
    padding:16px 14px 10px;
    background: rgba(244,241,234,.70);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid rgba(46,93,80,.10);
  }
  .topbar{
    max-width:560px;
    margin:0 auto;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .brand{
    display:flex;
    flex-direction:column;
    align-items:flex-start;
    line-height:1.1;
  }
  .brand h1{
    margin:0;
    font-size:18px;
    letter-spacing:.2px;
    color:var(--agave);
    font-weight:850;
  }
  .brand .sub{
    font-size:12px;
    opacity:.7;
    margin-top:3px;
  }
  .top-actions{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .chip{
    padding:10px 12px;
    border-radius:999px;
    border:1px solid rgba(46,93,80,.14);
    background: rgba(46,93,80,.06);
    color:var(--agave);
    font-weight:750;
    text-decoration:none;
    font-size:13px;
  }

  .stage{
    max-width:560px;
    margin:0 auto;
    padding:18px 14px 30px;
  }

  .hint{
    text-align:center;
    font-size:13px;
    opacity:.7;
    margin:6px 0 14px;
  }

  .stack{
    position:relative;
    height: 74vh;
    min-height: 520px;
  }

  .card{
    position:absolute;
    inset:0;
    border-radius: 26px;
    background: var(--card);
    box-shadow: var(--shadow);
    overflow:hidden;
    touch-action: pan-y;
    user-select:none;
    transform: translate3d(0,0,0);
  }

  .photo{
    height: 62%;
    background: linear-gradient(180deg, rgba(46,93,80,.08), rgba(199,169,107,.08));
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }
  .photo img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  .noPhoto{
    padding:24px;
    text-align:center;
    color: rgba(46,93,80,.80);
    font-weight:800;
  }

  .content{
    padding:16px 16px 14px;
  }
  .nameRow{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:10px;
  }
  .name{
    font-size:20px;
    font-weight:900;
    color:var(--agave);
    margin:0;
  }
  .meta{
    font-size:12px;
    opacity:.65;
    font-weight:650;
  }
  .msg{
    margin:10px 0 12px;
    line-height:1.35;
    font-size:15px;
    white-space: pre-wrap;
  }

  .song{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
  }
  .song a{
    text-decoration:none;
    font-weight:800;
    color: white;
    background: linear-gradient(180deg,var(--agave),#244d43);
    padding:10px 14px;
    border-radius: 14px;
    box-shadow: 0 10px 22px rgba(46,93,80,.20);
    display:inline-flex;
    align-items:center;
    gap:8px;
  }
  .song .ghost{
    text-decoration:none;
    font-weight:800;
    color: var(--agave);
    background: rgba(46,93,80,.08);
    border:1px solid rgba(46,93,80,.14);
    padding:10px 14px;
    border-radius: 14px;
    display:inline-flex;
    align-items:center;
    gap:8px;
  }

  .badge{
    position:absolute;
    top:18px;
    padding:10px 14px;
    border-radius: 16px;
    font-weight:950;
    letter-spacing:.8px;
    opacity:0;
    transition: opacity .12s ease;
    border:3px solid;
    background: rgba(255,255,255,.65);
    backdrop-filter: blur(6px);
  }
  .badge.next{
    left:18px;
    color: var(--agave);
    border-color: rgba(46,93,80,.85);
    transform: rotate(-10deg);
  }
  .badge.prev{
    right:18px;
    color: #8a6b22;
    border-color: rgba(199,169,107,.90);
    transform: rotate(10deg);
  }

  .controls{
    display:flex;
    justify-content:center;
    gap:14px;
    margin-top:16px;
  }
  .btn{
    width:54px;height:54px;
    border-radius:999px;
    border:none;
    background: white;
    box-shadow: 0 12px 26px rgba(0,0,0,.10);
    font-size:22px;
    font-weight:900;
    color: var(--agave);
    cursor:pointer;
  }
  .btn:active{ transform: translateY(1px); }

  .counter{
    text-align:center;
    margin-top:10px;
    font-size:12px;
    opacity:.7;
    font-weight:700;
  }

  .empty{
    height: 70vh;
    min-height: 420px;
    border-radius: 26px;
    background: rgba(255,255,255,.6);
    border:1px solid rgba(46,93,80,.12);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:24px;
    box-shadow: 0 12px 26px rgba(0,0,0,.06);
  }
  .empty div{ max-width:360px; }
  .empty h2{
    margin:0 0 8px;
    color:var(--agave);
    font-weight:900;
  }
  .empty p{
    margin:0;
    opacity:.75;
    line-height:1.35;
  }
</style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <h1>G√§stebuch</h1>
      <div class="sub">Swipe: rechts = n√§chster ¬∑ links = vorheriger</div>
    </div>
    <div class="top-actions">
      <a class="chip" href="form.html">+ Eintrag</a>
      <a class="chip" href="#" id="reload">‚Üª</a>
    </div>
  </div>
</header>

<div class="stage">
  <div class="hint" id="hint">Lade Eintr√§ge ‚Ä¶</div>

  <div class="stack" id="stack" style="display:none;">
    <div class="card" id="card">
      <div class="badge next" id="badgeNext">NEXT</div>
      <div class="badge prev" id="badgePrev">BACK</div>

      <div class="photo" id="photo"></div>

      <div class="content">
        <div class="nameRow">
          <h2 class="name" id="name">‚Äî</h2>
          <div class="meta" id="meta">‚Äî</div>
        </div>

        <div class="msg" id="msg"></div>

        <div class="song" id="songRow">
          <a href="#" target="_blank" rel="noopener" id="songBtn" style="display:none;">üéµ Song √∂ffnen</a>
          <a class="ghost" href="#" id="noSong" style="display:none;">Kein Song</a>
          <a class="ghost" href="form.html">‚úçÔ∏è Eintrag schreiben</a>
        </div>
      </div>
    </div>
  </div>

  <div class="empty" id="empty" style="display:none;">
    <div>
      <h2>Noch keine Eintr√§ge</h2>
      <p>Schreibe den ersten Eintrag im Formular ‚Äì dann kannst du hier durchswipen.</p>
      <div style="margin-top:14px;">
        <a class="chip" href="form.html">Zum Formular</a>
      </div>
    </div>
  </div>

  <div class="controls" id="controls" style="display:none;">
    <button class="btn" id="prevBtn" aria-label="Vorheriger">‚Äπ</button>
    <button class="btn" id="nextBtn" aria-label="N√§chster">‚Ä∫</button>
  </div>
  <div class="counter" id="counter" style="display:none;">‚Äî</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  // ==== Demo-Entries (werden genutzt, solange entries leer sind) ====
  const DEMO_ENTRIES = [
    {
      id: "demo1",
      name: "Anna",
      message: "Vielen Dank f√ºr die tolle Feier! Wir hatten mega Spa√ü üòä",
      photo: "https://picsum.photos/700/900?random=11",
      spotifyUrl: "https://music.apple.com/",
      created: Date.now() - 1000 * 60 * 55
    },
    {
      id: "demo2",
      name: "Markus",
      message: "Alles Gute euch beiden! Super Stimmung und tolles Essen!",
      photo: "https://picsum.photos/700/900?random=12",
      spotifyUrl: "",
      created: Date.now() - 1000 * 60 * 42
    },
    {
      id: "demo3",
      name: "Julia",
      message: "Wir w√ºnschen euch nur das Beste ‚ù§Ô∏è\nPS: Diese Kartenansicht ist ja mal genial!",
      photo: "https://picsum.photos/700/900?random=13",
      spotifyUrl: "https://open.spotify.com/",
      created: Date.now() - 1000 * 60 * 28
    },
    {
      id: "demo4",
      name: "Tom",
      message: "Mega Event ‚Äì gerne wieder üòÑ",
      photo: "",
      spotifyUrl: "",
      created: Date.now() - 1000 * 60 * 17
    }
  ];

  // ==== ioBroker State ====
  const ENTRIES_ID = '0_userdata.0.guestbook.entries';

  const hint = document.getElementById('hint');
  const stack = document.getElementById('stack');
  const card = document.getElementById('card');
  const empty = document.getElementById('empty');
  const controls = document.getElementById('controls');
  const counter = document.getElementById('counter');

  const photo = document.getElementById('photo');
  const nameEl = document.getElementById('name');
  const metaEl = document.getElementById('meta');
  const msgEl = document.getElementById('msg');
  const songBtn = document.getElementById('songBtn');
  const noSong = document.getElementById('noSong');

  const badgeNext = document.getElementById('badgeNext');
  const badgePrev = document.getElementById('badgePrev');

  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const reloadBtn = document.getElementById('reload');

  const socket = io.connect();

  let entries = [];
  let idx = 0;

  function safeParse(json, fallback){
    try { return JSON.parse(json); } catch { return fallback; }
  }

  function fmtTime(ts){
    if (!ts) return '';
    try{
      const d = new Date(Number(ts));
      return d.toLocaleString('de-DE', { day:'2-digit', month:'2-digit', year:'2-digit', hour:'2-digit', minute:'2-digit' });
    }catch{ return ''; }
  }

  function showEmpty(){
    stack.style.display = 'none';
    controls.style.display = 'none';
    counter.style.display = 'none';
    empty.style.display = 'flex';
    hint.textContent = '';
  }

  function showUI(){
    empty.style.display = 'none';
    stack.style.display = 'block';
    controls.style.display = 'flex';
    counter.style.display = 'block';
  }

  function getEntry(i){
    if (!entries.length) return null;
    const clamped = Math.max(0, Math.min(entries.length - 1, i));
    return entries[clamped];
  }

  function render(){
    if (!entries.length) return showEmpty();
    showUI();

    idx = Math.max(0, Math.min(entries.length - 1, idx));
    const e = getEntry(idx);

    photo.innerHTML = '';
    if (e.photo){
      const img = document.createElement('img');
      img.src = e.photo;
      img.alt = '';
      photo.appendChild(img);
    } else {
      const div = document.createElement('div');
      div.className = 'noPhoto';
      div.innerHTML = 'üì∑<br>Kein Foto';
      photo.appendChild(div);
    }

    nameEl.textContent = e.name || 'Unbekannt';
    metaEl.textContent = fmtTime(e.created) || '';

    msgEl.textContent = e.message || '';

    const url = (e.spotifyUrl || e.appleMusicUrl || e.songUrl || '').trim();
    if (url){
      songBtn.style.display = 'inline-flex';
      songBtn.href = url;
      noSong.style.display = 'none';
    } else {
      songBtn.style.display = 'none';
      noSong.style.display = 'inline-flex';
      noSong.href = '#';
      noSong.onclick = (ev) => ev.preventDefault();
    }

    counter.textContent = `${idx + 1} / ${entries.length}`;

    card.style.transition = 'none';
    card.style.transform = 'translate3d(0,0,0) rotate(0deg)';
    badgeNext.style.opacity = 0;
    badgePrev.style.opacity = 0;
  }

  function animateTo(direction){
    const width = Math.max(window.innerWidth, 360);
    const x = direction === 'next' ? width * 0.85 : -width * 0.85;
    const rot = direction === 'next' ? 10 : -10;

    card.style.transition = 'transform 220ms ease-out, opacity 220ms ease-out';
    card.style.transform = `translate3d(${x}px, -10px, 0) rotate(${rot}deg)`;
    card.style.opacity = 0.2;

    setTimeout(() => {
      card.style.opacity = 1;
      if (direction === 'next') idx = Math.min(entries.length - 1, idx + 1);
      else idx = Math.max(0, idx - 1);
      render();
    }, 220);
  }

  nextBtn.addEventListener('click', () => animateTo('next'));
  prevBtn.addEventListener('click', () => animateTo('prev'));
  reloadBtn.addEventListener('click', (e) => { e.preventDefault(); fetchEntries(); });

  // Swipe
  let startX = 0, startY = 0, dragging = false, lastDX = 0;

  function onDown(ev){
    dragging = true;
    startX = ev.clientX;
    startY = ev.clientY;
    lastDX = 0;
    card.setPointerCapture?.(ev.pointerId);
    card.style.transition = 'none';
  }

  function onMove(ev){
    if (!dragging) return;
    const dx = ev.clientX - startX;
    const dy = ev.clientY - startY;

    if (Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 12) return;

    lastDX = dx;
    const rot = Math.max(-12, Math.min(12, dx / 18));
    card.style.transform = `translate3d(${dx}px, 0, 0) rotate(${rot}deg)`;

    if (dx > 0){
      badgeNext.style.opacity = Math.min(1, dx / 110);
      badgePrev.style.opacity = 0;
    } else {
      badgePrev.style.opacity = Math.min(1, (-dx) / 110);
      badgeNext.style.opacity = 0;
    }
  }

  function onUp(){
    if (!dragging) return;
    dragging = false;

    const threshold = 120;
    if (lastDX > threshold){
      animateTo('next'); // rechts = n√§chster
    } else if (lastDX < -threshold){
      animateTo('prev'); // links = vorheriger
    } else {
      card.style.transition = 'transform 180ms ease-out';
      card.style.transform = 'translate3d(0,0,0) rotate(0deg)';
      badgeNext.style.opacity = 0;
      badgePrev.style.opacity = 0;
    }
  }

  card.addEventListener('pointerdown', onDown);
  card.addEventListener('pointermove', onMove);
  card.addEventListener('pointerup', onUp);
  card.addEventListener('pointercancel', onUp);

  function fetchEntries(){
    hint.textContent = 'Lade Eintr√§ge ‚Ä¶';
    socket.emit('getState', ENTRIES_ID, (err, state) => {
      if (err){
        hint.textContent = 'Fehler beim Laden.';
        return;
      }
      const raw = (state && state.val) ? String(state.val) : '[]';
      const arr = safeParse(raw, []);
      entries = Array.isArray(arr) ? arr : [];

      // wenn noch keine echten Eintr√§ge existieren -> Demo anzeigen
      if (!entries.length) entries = DEMO_ENTRIES.slice();

      hint.textContent = '';
      idx = 0;
      render();
    });
  }

  // Live Updates
  socket.emit('subscribe', ENTRIES_ID);
  socket.on('stateChange', (id, state) => {
    if (id !== ENTRIES_ID) return;
    const raw = (state && state.val) ? String(state.val) : '[]';
    const arr = safeParse(raw, []);
    if (Array.isArray(arr)){
      const oldId = entries[idx]?.id;
      entries = arr.length ? arr : DEMO_ENTRIES.slice();
      if (oldId){
        const newIndex = entries.findIndex(e => e.id === oldId);
        idx = newIndex >= 0 ? newIndex : Math.min(idx, entries.length - 1);
      } else {
        idx = Math.min(idx, entries.length - 1);
      }
      hint.textContent = '';
      render();
    }
  });

  fetchEntries();
</script>
</body>
</html>
