<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>G√§stebuch Swipe</title>

<style>
  :root{
    --agave:#2e5d50;
    --agave2:#244d43;
    --gold:#c7a96b;
    --ink:#1d2b27;
    --bg1:#e7efe9;
    --bg2:#f4f1ea;
    --card:#ffffff;
    --shadow:0 28px 80px rgba(0,0,0,.16);
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    color: var(--ink);
    overflow:hidden; /* Vollbild, kein Body-Scroll */
  }

  .stage{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 0;
  }

  .stack{
    position:relative;
    width:100%;
    height:100%;
  }

  .card{
    position:absolute;
    inset:0;
    background: var(--card);
    border-radius: 0;
    box-shadow: none;
    overflow:hidden;
    transform: translate3d(0,0,0);
    will-change: transform;
    touch-action: pan-y; /* vertikal scrollen erlauben */
    user-select:none;
  }

  /* n√§chste Karte leicht sichtbar */
  .card.back{
    inset:10px;
    border-radius: 28px;
    box-shadow: var(--shadow);
    opacity:.55;
    transform: scale(.985) translateY(8px);
    filter: blur(.2px);
  }

  .card.front{
    inset:0;
    border-radius: 0;
  }

  .photo{
    height: 58vh;
    min-height: 320px;
    background: linear-gradient(180deg, rgba(46,93,80,.18), rgba(199,169,107,.14));
    overflow:hidden;
    position:relative;
  }
  .photo img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
    transform: scale(1.01);
  }

  .badge{
    position:absolute;
    top: 18px;
    padding: 10px 14px;
    border-radius: 18px;
    font-weight: 950;
    letter-spacing: .9px;
    opacity: 0;
    transition: opacity .12s ease;
    background: rgba(255,255,255,.70);
    backdrop-filter: blur(10px);
    border: 3px solid;
    z-index:5;
  }
  .badge.next{
    left: 18px;
    color: var(--agave);
    border-color: rgba(46,93,80,.90);
    transform: rotate(-10deg);
  }
  .badge.prev{
    right: 18px;
    color: #8a6b22;
    border-color: rgba(199,169,107,.95);
    transform: rotate(10deg);
  }

  .content{
    height: calc(100% - 58vh);
    min-height: 280px;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 18px 18px 26px;
    background: linear-gradient(180deg, rgba(255,255,255,1), rgba(255,255,255,.98));
  }

  .nameRow{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:10px;
  }
  .name{
    margin:0;
    font-size: 24px;
    font-weight: 950;
    color: var(--agave);
    letter-spacing:.2px;
  }
  .place{
    margin:0;
    font-size: 13px;
    opacity:.75;
    font-weight: 850;
    white-space:nowrap;
  }
  .text{
    margin: 12px 0 14px;
    font-size: 15.5px;
    line-height: 1.38;
    opacity:.92;
    white-space: pre-wrap;
  }

  /* NEU: Kacki-Block */
  .kacki{
    margin: 10px 0 14px;
    padding: 12px 12px;
    border-radius: 16px;
    background: rgba(199,169,107,.14);
    border: 1px solid rgba(199,169,107,.22);
  }
  .kacki .q{
    font-size: 12px;
    font-weight: 950;
    letter-spacing:.2px;
    opacity:.78;
    margin-bottom:6px;
  }
  .kacki .a{
    font-weight: 900;
    color: #5b3b00;
  }

  .songCard{
    display:flex;
    align-items:center;
    gap:12px;
    background: rgba(199,169,107,.12);
    border-radius: 18px;
    padding: 12px 12px;
    border: 1px solid rgba(199,169,107,.25);
  }
  .songCover{
    width:64px;
    height:64px;
    border-radius: 14px;
    object-fit: cover;
    box-shadow: 0 14px 28px rgba(0,0,0,.12);
    background: linear-gradient(180deg, rgba(46,93,80,.18), rgba(199,169,107,.18));
    flex: 0 0 auto;
  }
  .songMeta{
    flex:1;
    min-width:0;
    text-align:left;
  }
  .songTitle{
    font-weight: 950;
    font-size: 14px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .songArtist{
    margin-top:2px;
    font-size: 12px;
    opacity:.74;
    font-weight: 750;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .songPlay{
    width:46px;
    height:46px;
    border-radius: 14px;
    background: linear-gradient(180deg,var(--agave),var(--agave2));
    display:flex;
    align-items:center;
    justify-content:center;
    color:white;
    font-weight: 950;
    text-decoration:none;
    box-shadow: 0 14px 28px rgba(46,93,80,.18);
    flex: 0 0 auto;
  }

  /* NEU: ‚ÄúEnde‚Äù-Teaser (wird nur hinter der letzten Karte leicht sichtbar) */
  .endTeaser{
    height:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding: 32px;
    background: linear-gradient(180deg, rgba(46,93,80,.06), rgba(199,169,107,.08));
  }
  .endTeaser .t{
    font-weight: 950;
    font-size: 26px;
    color: var(--agave);
    letter-spacing:.2px;
  }
  .endTeaser .s{
    margin-top:10px;
    font-weight: 850;
    opacity:.70;
    font-size: 13px;
  }

  /* Subtiler ‚ÄúHint‚Äù ohne Text: einmaliges Mini-Wackeln */
  @keyframes nudge{
    0%   { transform: translate3d(0,0,0) rotate(0deg); }
    18%  { transform: translate3d(-16px,0,0) rotate(-1.2deg); }
    36%  { transform: translate3d(12px,0,0) rotate(0.9deg); }
    54%  { transform: translate3d(-10px,0,0) rotate(-0.8deg); }
    72%  { transform: translate3d(8px,0,0) rotate(0.6deg); }
    100% { transform: translate3d(0,0,0) rotate(0deg); }
  }
  .nudgeOnce{
    animation: nudge 920ms cubic-bezier(.2,.9,.2,1) 1;
  }

  @media (max-height: 740px){
    .photo{ height: 54vh; }
    .content{ height: calc(100% - 54vh); }
  }
</style>
</head>

<body>

<div class="stage">
  <div class="stack">
    <div class="card back" id="cardBack" aria-hidden="true"></div>

    <div class="card front" id="cardFront">
      <div class="badge next" id="badgeNext">NEXT</div>
      <div class="badge prev" id="badgePrev">BACK</div>

      <div class="photo" id="photo"></div>

      <div class="content" id="content">
        <div class="nameRow">
          <h2 class="name" id="name">‚Äî</h2>
          <p class="place" id="place">‚Äî</p>
        </div>

        <div class="text" id="text">‚Äî</div>

        <!-- NEU: Kacki -->
        <div class="kacki" id="kacki">
          <div class="q">Wie war dein Kacki heute?</div>
          <div class="a" id="kackiVal">‚Äî</div>
        </div>

        <div class="songCard" id="songCard">
          <img id="songCover" class="songCover" alt="">
          <div class="songMeta">
            <div id="songTitle" class="songTitle">Lade Song ‚Ä¶</div>
            <div id="songArtist" class="songArtist">‚Äî</div>
          </div>
          <a id="songBtn" class="songPlay" href="#" target="_blank" rel="noopener">‚ñ∂</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Demo-Daten: Apple Music Track IDs
  // Beispiel: https://music.apple.com/de/album/message-in-a-bottle/214355871?i=214356293  -> Track-ID = 214356293
  const entries = [
    {
      id: "d1",
      name: "Anna",
      place: "Dreieich",
      text: "So sch√∂n, dass wir dabei sein durften! ü•∞\nEuer G√§stebuch ist einfach next level.\n\nUnd ja: ich schreibe absichtlich l√§nger, damit wir das Scrollen testen k√∂nnen.\n\nNoch ein Absatz‚Ä¶ noch ein Absatz‚Ä¶ üòÑ",
      kacki: "Heute sch√∂n stabil ‚Äì 10/10 üí©‚ú®",
      photo: "https://picsum.photos/1200/1600?random=61",
      appleTrackId: 214356293
    },
    {
      id: "d2",
      name: "Markus",
      place: "Offenbach",
      text: "Mega Stimmung, super Leute ‚Äì und das Essen war brutal gut.\nDanke f√ºr den tollen Abend! ‚ú®",
      kacki: "Solide, p√ºnktlich, zuverl√§ssig üòÑ",
      photo: "https://picsum.photos/1200/1600?random=62",
      appleTrackId: 909253
    },
    {
      id: "d3",
      name: "Julia",
      place: "Frankfurt",
      text: "Wir w√ºnschen euch nur das Beste ‚ù§Ô∏è\nBleibt genau so wie ihr seid!\n\nPS: Das Swipe-Design ist richtig geil.",
      kacki: "Heute eher 'meh'‚Ä¶ aber wir reden nicht dr√ºber üôà",
      photo: "https://picsum.photos/1200/1600?random=63",
      appleTrackId: 1440833081
    },
    {
      id: "d4",
      name: "Tom",
      place: "Neu-Isenburg",
      text: "Das ist offiziell das coolste G√§stebuch ever.\nSwipe-Game strong üòÑ",
      kacki: "Kurzer Besuch ‚Äì langer Abschied üòÇ",
      photo: "https://picsum.photos/1200/1600?random=64",
      appleTrackId: 1440833130
    }
  ];

  const cardFront = document.getElementById('cardFront');
  const cardBack  = document.getElementById('cardBack');

  const photoEl = document.getElementById('photo');
  const contentEl = document.getElementById('content');

  const nameEl  = document.getElementById('name');
  const placeEl = document.getElementById('place');
  const textEl  = document.getElementById('text');

  const kackiValEl = document.getElementById('kackiVal');

  const songCoverEl = document.getElementById('songCover');
  const songTitleEl = document.getElementById('songTitle');
  const songArtistEl= document.getElementById('songArtist');
  const songBtn     = document.getElementById('songBtn');

  const badgeNext = document.getElementById('badgeNext');
  const badgePrev = document.getElementById('badgePrev');

  let idx = 0;

  const songCache = new Map();

  function clamp(i){ return Math.max(0, Math.min(entries.length - 1, i)); }
  function get(i){ return entries[clamp(i)]; }

  function setFrontReset(){
    cardFront.style.transition = 'none';
    cardFront.style.transform = 'translate3d(0,0,0) rotate(0deg)';
    cardFront.style.opacity = 1;
    badgeNext.style.opacity = 0;
    badgePrev.style.opacity = 0;
  }

  // NEU: Ende-Teaser statt Wiederholung der letzten Seite
  function renderBackPreview(){
    if (idx >= entries.length - 1){
      cardBack.innerHTML = `
        <div class="endTeaser">
          <div class="t">Ende</div>
          <div class="s">Danke f√ºrs Durchbl√§ttern ‚ú®</div>
        </div>
      `;
      return;
    }
    const next = entries[idx + 1];
    cardBack.innerHTML = `<div class="photo"><img src="${next.photo}" alt=""></div>`;
  }

  function setSongFallback(trackId){
    songCoverEl.removeAttribute('src');
    songCoverEl.style.background = 'linear-gradient(180deg, rgba(46,93,80,.18), rgba(199,169,107,.18))';
    songTitleEl.textContent = trackId ? `Apple Music Track #${trackId}` : 'Lieblingssong';
    songArtistEl.textContent = '‚Äî';
    songBtn.href = '#';
    songBtn.onclick = (e) => e.preventDefault();
  }

  async function loadSong(trackId){
    if (!trackId){ setSongFallback(null); return; }
    if (songCache.has(trackId)){ applySong(songCache.get(trackId)); return; }

    const url = `https://itunes.apple.com/lookup?id=${encodeURIComponent(trackId)}&entity=song`;
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), 2500);

    try{
      const res = await fetch(url, { signal: controller.signal });
      clearTimeout(t);
      if (!res.ok) throw new Error('lookup http ' + res.status);
      const data = await res.json();
      const item = (data.results || []).find(r => r.wrapperType === 'track') || data.results?.[0];
      if (!item) throw new Error('no track');

      const artwork = (item.artworkUrl100 || item.artworkUrl60 || '').replace('100x100', '600x600');
      const payload = {
        trackName: item.trackName || 'Unbekannt',
        artistName: item.artistName || '',
        artworkUrl: artwork,
        trackViewUrl: item.trackViewUrl || ''
      };
      songCache.set(trackId, payload);
      applySong(payload);
    }catch(e){
      clearTimeout(t);
      setSongFallback(trackId);
    }
  }

  function applySong(s){
    if (s.artworkUrl){
      songCoverEl.src = s.artworkUrl;
      songCoverEl.style.background = 'transparent';
    } else {
      songCoverEl.removeAttribute('src');
      songCoverEl.style.background = 'linear-gradient(180deg, rgba(46,93,80,.18), rgba(199,169,107,.18))';
    }
    songTitleEl.textContent = s.trackName || '‚Äî';
    songArtistEl.textContent = s.artistName || '‚Äî';

    if (s.trackViewUrl){
      songBtn.href = s.trackViewUrl;
      songBtn.onclick = null;
    } else {
      songBtn.href = '#';
      songBtn.onclick = (e) => e.preventDefault();
    }
  }

  function render(){
    const e = get(idx);

    photoEl.innerHTML = `<img src="${e.photo}" alt="">`;
    nameEl.textContent = e.name;
    placeEl.textContent = e.place;
    textEl.textContent = e.text;

    // NEU: Kacki
    kackiValEl.textContent = e.kacki || "‚Äî";

    // beim Wechsel immer nach oben scrollen
    contentEl.scrollTop = 0;

    // song placeholder
    setSongFallback(e.appleTrackId);
    loadSong(e.appleTrackId);

    setFrontReset();
    renderBackPreview();
  }

  // Swipe wie ein Buch:
  // Swipe links = n√§chster (weiterbl√§ttern)
  // Swipe rechts = vorheriger (zur√ºckbl√§ttern)
  function go(direction){
    // direction: 'next' or 'prev'
    const w = Math.max(window.innerWidth, 360);
    const x = direction === 'next' ? -w * 0.90 : w * 0.90; // next fliegt nach LINKS raus
    const rot = direction === 'next' ? -14 : 14;

    cardFront.style.transition = 'transform 240ms ease-out, opacity 240ms ease-out';
    cardFront.style.transform = `translate3d(${x}px, -10px, 0) rotate(${rot}deg)`;
    cardFront.style.opacity = 0.2;

    setTimeout(() => {
      if (direction === 'next') idx = clamp(idx + 1);
      else idx = clamp(idx - 1);
      render();
    }, 240);
  }

  // ===== Swipe handling =====
  let startX = 0, startY = 0, dragging = false, lastDX = 0;

  function onDown(ev){
    dragging = true;
    startX = ev.clientX;
    startY = ev.clientY;
    lastDX = 0;
    cardFront.setPointerCapture?.(ev.pointerId);
    cardFront.style.transition = 'none';
  }

  function onMove(ev){
    if (!dragging) return;

    const dx = ev.clientX - startX;
    const dy = ev.clientY - startY;

    // vertikal dominiert -> nicht swipen (damit scroll f√ºr lange Texte klappt)
    if (Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 12) return;

    lastDX = dx;
    const rot = Math.max(-16, Math.min(16, dx / 15));
    cardFront.style.transform = `translate3d(${dx}px, 0, 0) rotate(${rot}deg)`;

    // Badges passend zur Buchlogik:
    // dx < 0 (Swipe nach links) => NEXT
    // dx > 0 (Swipe nach rechts) => BACK
    if (dx < 0){
      badgeNext.style.opacity = Math.min(1, (-dx) / 120);
      badgePrev.style.opacity = 0;
    } else {
      badgePrev.style.opacity = Math.min(1, dx / 120);
      badgeNext.style.opacity = 0;
    }
  }

  function onUp(){
    if (!dragging) return;
    dragging = false;

    const threshold = 130;

    // NEU: am Ende nicht "umklappen" zur letzten Karte -> einfach zur√ºcksnappen
    if (idx >= entries.length - 1 && lastDX < -threshold){
      cardFront.style.transition = 'transform 180ms ease-out';
      cardFront.style.transform = 'translate3d(0,0,0) rotate(0deg)';
      badgeNext.style.opacity = 0;
      badgePrev.style.opacity = 0;
      return;
    }

    if (lastDX < -threshold){
      go('next'); // swipe links -> n√§chster
    } else if (lastDX > threshold){
      go('prev'); // swipe rechts -> vorheriger
    } else {
      cardFront.style.transition = 'transform 180ms ease-out';
      cardFront.style.transform = 'translate3d(0,0,0) rotate(0deg)';
      badgeNext.style.opacity = 0;
      badgePrev.style.opacity = 0;
    }
  }

  cardFront.addEventListener('pointerdown', onDown);
  cardFront.addEventListener('pointermove', onMove);
  cardFront.addEventListener('pointerup', onUp);
  cardFront.addEventListener('pointercancel', onUp);

  // Einmaliger subtiler ‚ÄúNudge‚Äù beim Start (zeigt, dass man swipen kann)
  function nudgeOnce(){
    cardFront.classList.add('nudgeOnce');
    setTimeout(() => cardFront.classList.remove('nudgeOnce'), 1000);
  }

  // Init
  render();
  setTimeout(nudgeOnce, 450);
</script>

</body>
</html>
