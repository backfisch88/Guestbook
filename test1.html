<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GÃ¤stebuch Â· Eintrag</title>

<style>
  :root{
    --agave:#2e5d50;
    --agave2:#244d43;
    --gold:#c7a96b;
    --ink:#1d2b27;
    --bg1:#e7efe9;
    --bg2:#f4f1ea;
    --card:#ffffff;
    --shadow:0 22px 60px rgba(0,0,0,.12);
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    color: var(--ink);
  }

  .wrap{
    max-width: 720px;
    margin: 0 auto;
    padding: 22px 16px 34px;
  }

  .hero{
    background: rgba(255,255,255,.65);
    border: 1px solid rgba(46,93,80,.10);
    border-radius: 26px;
    padding: 18px 16px;
    box-shadow: 0 18px 42px rgba(0,0,0,.08);
    backdrop-filter: blur(12px);
  }

  .title{
    margin:0;
    font-size: 22px;
    font-weight: 950;
    color: var(--agave);
    letter-spacing:.2px;
  }
  .sub{
    margin:8px 0 0;
    font-size: 13px;
    opacity:.75;
    font-weight: 700;
    line-height:1.35;
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr;
    gap: 12px;
    margin-top: 14px;
  }

  .field{
    background: white;
    border-radius: 18px;
    border: 1px solid rgba(46,93,80,.12);
    box-shadow: 0 10px 22px rgba(0,0,0,.06);
    padding: 12px 12px;
  }

  label{
    display:block;
    font-size: 12px;
    font-weight: 900;
    letter-spacing:.2px;
    color: rgba(29,43,39,.78);
    margin-bottom: 8px;
  }

  input, textarea{
    width:100%;
    border: none;
    outline:none;
    font-size: 16px;
    font-weight: 700;
    color: var(--ink);
    background: transparent;
  }
  textarea{
    min-height: 120px;
    resize: vertical;
    line-height: 1.35;
    font-weight: 650;
  }

  .row2{
    display:grid;
    gap: 12px;
    grid-template-columns: 1fr 1fr;
  }
  @media (max-width:520px){
    .row2{ grid-template-columns: 1fr; }
  }

  .hint{
    font-size: 12px;
    opacity:.72;
    margin-top:8px;
    line-height:1.35;
  }

  .songBox{
    display:flex;
    gap:10px;
    align-items:center;
  }
  .songSearch{
    flex:1;
  }
  .btn{
    border:none;
    cursor:pointer;
    padding: 12px 14px;
    border-radius: 16px;
    font-weight: 950;
    letter-spacing:.2px;
    background: linear-gradient(180deg,var(--agave),var(--agave2));
    color:white;
    box-shadow: 0 14px 28px rgba(46,93,80,.18);
    white-space:nowrap;
  }
  .btnGhost{
    background: rgba(46,93,80,.08);
    border: 1px solid rgba(46,93,80,.16);
    color: var(--agave);
    box-shadow: none;
  }

  .results{
    margin-top: 10px;
    display:grid;
    gap:10px;
  }
  .result{
    display:flex;
    gap:12px;
    align-items:center;
    background: rgba(199,169,107,.12);
    border: 1px solid rgba(199,169,107,.25);
    border-radius: 18px;
    padding: 10px 10px;
    cursor:pointer;
    user-select:none;
  }
  .cover{
    width:54px;height:54px;border-radius:14px;object-fit:cover;
    background: linear-gradient(180deg, rgba(46,93,80,.18), rgba(199,169,107,.18));
    box-shadow: 0 12px 24px rgba(0,0,0,.10);
    flex:0 0 auto;
  }
  .rmeta{ flex:1; min-width:0; }
  .rtitle{
    font-weight: 950;
    font-size: 14px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .rartist{
    margin-top:2px;
    font-size: 12px;
    opacity:.75;
    font-weight: 750;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .pick{
    font-weight: 950;
    color: var(--agave);
    padding: 10px 12px;
    border-radius: 14px;
    background: rgba(46,93,80,.10);
    border: 1px solid rgba(46,93,80,.16);
  }

  .chosen{
    margin-top: 12px;
    border-radius: 20px;
    border: 1px solid rgba(46,93,80,.12);
    background: rgba(255,255,255,.75);
    padding: 12px 12px;
    display:flex;
    gap:12px;
    align-items:center;
  }
  .chosen .cover{ width:62px;height:62px; }
  .chosen .rtitle{ font-size: 15px; }
  .chosen small{ opacity:.7; font-weight:800; }

  .footerRow{
    margin-top: 14px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .toast{
    margin-top: 14px;
    padding: 12px 12px;
    border-radius: 16px;
    background: rgba(46,93,80,.10);
    border: 1px solid rgba(46,93,80,.14);
    color: var(--agave);
    font-weight: 850;
    display:none;
  }

  .preview{
    margin-top: 14px;
    border-radius: 26px;
    overflow:hidden;
    border: 1px solid rgba(46,93,80,.12);
    box-shadow: 0 18px 42px rgba(0,0,0,.08);
    background:white;
  }
  .preview .pimg{
    height: 260px;
    background: linear-gradient(180deg, rgba(46,93,80,.12), rgba(199,169,107,.12));
    display:flex;align-items:center;justify-content:center;
    overflow:hidden;
  }
  .preview .pimg img{ width:100%;height:100%;object-fit:cover; display:block; }
  .preview .pbody{ padding: 14px 14px 16px; }
  .preview .pname{ font-weight: 950; color: var(--agave); font-size: 18px; }
  .preview .pplace{ opacity:.7; font-weight:850; font-size: 12px; margin-top:2px; }
  .preview .ptext{ margin-top:10px; white-space:pre-wrap; line-height:1.35; }
</style>
</head>

<body>
<div class="wrap">
  <div class="hero">
    <h1 class="title">GÃ¤stebuch-Eintrag</h1>
    <p class="sub">Demo-Modus: Es wird nichts gespeichert. Du siehst nur eine Vorschau und kannst die Song-Suche testen.</p>

    <div class="grid">
      <div class="row2">
        <div class="field">
          <label for="name">Name</label>
          <input id="name" autocomplete="name" placeholder="z.B. Anna" />
        </div>
        <div class="field">
          <label for="place">Wohnort</label>
          <input id="place" autocomplete="address-level2" placeholder="z.B. Frankfurt" />
        </div>
      </div>

      <div class="field">
        <label for="text">Text zur freien VerfÃ¼gung</label>
        <textarea id="text" placeholder="Schreib was Nettes (oder Lustiges) ðŸ˜Š"></textarea>
      </div>

      <div class="field">
        <label for="kacki">Wie war dein Kacki heute? ðŸ’©</label>
        <input id="kacki" placeholder="z.B. stabil / wild / kritisch / 10/10" />
        <div class="hint">NatÃ¼rlich nur als SpaÃŸ â€” du kannst auch einfach â€žKeine Angabeâ€œ schreiben ðŸ˜„</div>
      </div>

      <div class="field">
        <label>Foto (Demo)</label>
        <div class="songBox">
          <input id="photo" class="songSearch" placeholder="Bild-URL (optional) z.B. https://â€¦" />
          <button class="btn btnGhost" id="randomPhoto" type="button">Zufallsfoto</button>
        </div>
        <div class="hint">Im echten Modus kÃ¶nntest du hier Upload (iPhone Kamera) einbauen. FÃ¼r Demo reicht eine URL.</div>
      </div>

      <div class="field">
        <label>Lieblingssong (Apple Music / iTunes Suche)</label>
        <div class="songBox">
          <input id="songQuery" class="songSearch" placeholder="z.B. message in a bottle (The Police)" />
          <button class="btn" id="songSearchBtn" type="button">Suchen</button>
        </div>
        <div class="hint">Tippe unten einen Treffer an â€” dann wird er Ã¼bernommen.</div>

        <div class="results" id="results" aria-live="polite"></div>

        <div class="chosen" id="chosen" style="display:none;">
          <img class="cover" id="chosenCover" alt="">
          <div class="rmeta">
            <div class="rtitle" id="chosenTitle">â€”</div>
            <div class="rartist" id="chosenArtist">â€”</div>
            <small id="chosenInfo">â€”</small>
          </div>
          <a class="pick" id="chosenOpen" href="#" target="_blank" rel="noopener">Ã–ffnen</a>
        </div>
      </div>

      <div class="footerRow">
        <button class="btn" id="submit" type="button">Eintrag (Demo) absenden</button>
        <button class="btn btnGhost" id="toWall" type="button">Zur Swipe-Ansicht</button>
      </div>

      <div class="toast" id="toast">Demo: â€žAbsendenâ€œ gedrÃ¼ckt (nichts gespeichert).</div>

      <div class="preview" id="preview">
        <div class="pimg" id="pimg">
          <div style="opacity:.75;font-weight:900;color:var(--agave);">Vorschau-Foto</div>
        </div>
        <div class="pbody">
          <div class="pname" id="pname">â€”</div>
          <div class="pplace" id="pplace">â€”</div>
          <div class="ptext" id="ptext">â€”</div>
          <div class="hint" id="pkacki" style="margin-top:10px;font-weight:900;">â€”</div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  // =========================
  // Demo-Konfiguration
  // =========================
  const WALL_URL = "test.html"; // falls deine Swipe-Datei anders heiÃŸt -> anpassen
  const DEFAULT_PHOTO = "https://picsum.photos/1200/1600?random=80";

  // =========================
  // Elements
  // =========================
  const elName = document.getElementById('name');
  const elPlace = document.getElementById('place');
  const elText = document.getElementById('text');
  const elKacki = document.getElementById('kacki');
  const elPhoto = document.getElementById('photo');

  const elSongQuery = document.getElementById('songQuery');
  const elResults = document.getElementById('results');

  const chosen = document.getElementById('chosen');
  const chosenCover = document.getElementById('chosenCover');
  const chosenTitle = document.getElementById('chosenTitle');
  const chosenArtist = document.getElementById('chosenArtist');
  const chosenInfo = document.getElementById('chosenInfo');
  const chosenOpen = document.getElementById('chosenOpen');

  const toast = document.getElementById('toast');

  // Preview
  const pimg = document.getElementById('pimg');
  const pname = document.getElementById('pname');
  const pplace = document.getElementById('pplace');
  const ptext = document.getElementById('ptext');
  const pkacki = document.getElementById('pkacki');

  let selectedSong = null; // { trackId, trackName, artistName, artworkUrl, trackViewUrl }

  // =========================
  // Helpers
  // =========================
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;")
      .replaceAll("\n","<br>");
  }

  function setPreview(){
    const n = elName.value.trim() || "â€”";
    const p = elPlace.value.trim() || "â€”";
    const t = elText.value.trim() || "â€”";
    const k = elKacki.value.trim() || "â€”";
    const photoUrl = elPhoto.value.trim();

    pname.textContent = n;
    pplace.textContent = p;
    ptext.textContent = t;
    pkacki.textContent = "Wie war dein Kacki heute? " + (k || "â€”");

    if (photoUrl){
      pimg.innerHTML = `<img src="${photoUrl}" alt="">`;
    } else {
      pimg.innerHTML = `<div style="opacity:.75;font-weight:900;color:var(--agave);">Vorschau-Foto</div>`;
    }
  }

  function showToast(){
    toast.style.display = "block";
    setTimeout(() => toast.style.display = "none", 2200);
  }

  function setChosen(song){
    selectedSong = song;
    chosen.style.display = "flex";
    chosenCover.src = song.artworkUrl || "";
    chosenTitle.textContent = song.trackName || "â€”";
    chosenArtist.textContent = song.artistName || "â€”";
    chosenInfo.textContent = "Track-ID: " + (song.trackId || "â€”");
    chosenOpen.href = song.trackViewUrl || "#";
  }

  // =========================
  // Apple Music / iTunes Search
  // =========================
  async function searchSongs(q){
    elResults.innerHTML = "";
    if (!q || q.trim().length < 2) return;

    const url = `https://itunes.apple.com/search?term=${encodeURIComponent(q)}&entity=song&limit=6&country=DE`;
    try{
      const res = await fetch(url);
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      const items = (data.results || []).filter(r => r.wrapperType === "track");

      if (!items.length){
        elResults.innerHTML = `<div class="hint">Keine Treffer gefunden.</div>`;
        return;
      }

      elResults.innerHTML = items.map((r, i) => {
        const cover = (r.artworkUrl100 || "").replace("100x100","200x200");
        return `
          <div class="result" data-i="${i}">
            <img class="cover" src="${cover}" alt="">
            <div class="rmeta">
              <div class="rtitle">${escapeHtml(r.trackName || "")}</div>
              <div class="rartist">${escapeHtml(r.artistName || "")}</div>
            </div>
            <div class="pick">WÃ¤hlen</div>
          </div>
        `;
      }).join("");

      // click handlers
      [...elResults.querySelectorAll(".result")].forEach(node => {
        node.addEventListener("click", () => {
          const i = Number(node.getAttribute("data-i"));
          const r = items[i];

          setChosen({
            trackId: r.trackId,
            trackName: r.trackName,
            artistName: r.artistName,
            artworkUrl: (r.artworkUrl100 || "").replace("100x100","600x600"),
            trackViewUrl: r.trackViewUrl
          });
        });
      });

    }catch(e){
      elResults.innerHTML = `<div class="hint">Suche fehlgeschlagen (z.B. kein Internet im Gastnetz). In Demo egal ðŸ™‚</div>`;
    }
  }

  // =========================
  // Events
  // =========================
  document.getElementById('songSearchBtn').addEventListener('click', () => {
    searchSongs(elSongQuery.value);
  });

  elSongQuery.addEventListener('keydown', (e) => {
    if (e.key === "Enter"){
      e.preventDefault();
      searchSongs(elSongQuery.value);
    }
  });

  document.getElementById('randomPhoto').addEventListener('click', () => {
    elPhoto.value = "https://picsum.photos/1200/1600?random=" + Math.floor(Math.random()*1000);
    setPreview();
  });

  document.getElementById('submit').addEventListener('click', () => {
    // Demo: wir zeigen nur Toast + Vorschau, speichern NICHTS
    // Hier wÃ¼rdest du spÃ¤ter in ioBroker schreiben (0_userdata.0.guestbook.entries) oder per REST endpoint.
    showToast();

    // Optional: Konsolen-Output als â€œPseudo-Speichernâ€
    const payload = {
      name: elName.value.trim(),
      place: elPlace.value.trim(),
      text: elText.value.trim(),
      kacki: elKacki.value.trim(),
      photo: elPhoto.value.trim() || DEFAULT_PHOTO,
      appleTrackId: selectedSong?.trackId || null,
      appleTrackUrl: selectedSong?.trackViewUrl || null,
      created: Date.now()
    };
    console.log("DEMO payload:", payload);
  });

  document.getElementById('toWall').addEventListener('click', () => {
    location.href = WALL_URL;
  });

  [elName, elPlace, elText, elKacki, elPhoto].forEach(el => {
    el.addEventListener('input', setPreview);
  });

  // init defaults
  elPhoto.value = "";
  elSongQuery.value = "Message in a Bottle";
  setPreview();
  // optional: direkt Demo-Suche starten
  searchSongs(elSongQuery.value);
</script>
</body>
</html>
