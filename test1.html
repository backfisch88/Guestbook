<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GÃ¤stebuch Â· Eintrag</title>

<style>
  :root{
    --agave:#2e5d50;
    --agave2:#244d43;
    --gold:#c7a96b;
    --ink:#1d2b27;
    --bg1:#e7efe9;
    --bg2:#f4f1ea;
  }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    color: var(--ink);
  }

  .wrap{ max-width:720px; margin:0 auto; padding:22px 16px 34px; }

  .hero{
    background: rgba(255,255,255,.65);
    border: 1px solid rgba(46,93,80,.10);
    border-radius: 26px;
    padding: 18px 16px;
    box-shadow: 0 18px 42px rgba(0,0,0,.08);
    backdrop-filter: blur(12px);
  }

  .title{ margin:0; font-size:22px; font-weight:950; color:var(--agave); }
  .sub{ margin:8px 0 0; font-size:13px; opacity:.75; font-weight:700; line-height:1.35; }

  .grid{ display:grid; gap:12px; margin-top:14px; }

  .field{
    background:white;
    border-radius:18px;
    border:1px solid rgba(46,93,80,.12);
    box-shadow:0 10px 22px rgba(0,0,0,.06);
    padding:14px 16px;
  }

  label{
    display:block;
    font-size:12px;
    font-weight:900;
    color: rgba(29,43,39,.78);
    margin-bottom:8px;
  }

  input,textarea{
    width:100%;
    border:none;
    outline:none;
    font-size:16px;
    font-weight:700;
    color:var(--ink);
    background:transparent;
    padding:10px 10px;
    box-sizing:border-box;
  }
  textarea{ min-height:120px; resize:vertical; line-height:1.35; font-weight:650; }

  .row2{ display:grid; gap:12px; grid-template-columns:1fr 1fr; }
  @media (max-width:520px){ .row2{ grid-template-columns:1fr; } }

  .hint{ font-size:12px; opacity:.72; margin-top:8px; line-height:1.35; }

  .songBox{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .songSearch{ flex:1 1 240px; min-width:180px; }

  .btn{
    border:none;
    cursor:pointer;
    padding:12px 14px;
    border-radius:16px;
    font-weight:950;
    background: linear-gradient(180deg,var(--agave),var(--agave2));
    color:white;
    box-shadow:0 14px 28px rgba(46,93,80,.18);
    white-space:nowrap;
  }
  .btnGhost{
    background: rgba(46,93,80,.08);
    border: 1px solid rgba(46,93,80,.16);
    color: var(--agave);
    box-shadow:none;
  }

  /* ===== Song results collapsible ===== */
  .songResultsWrap{
    margin-top:10px;
    border-radius:18px;
    overflow:hidden;
    border:1px solid rgba(199,169,107,.25);
    background: rgba(199,169,107,.08);
  }
  .songResultsHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:10px 12px;
    cursor:pointer;
    user-select:none;
  }
  .songResultsHeader .hTitle{ font-weight:950; font-size:13px; color:rgba(29,43,39,.78); }
  .songResultsHeader .chev{
    width:32px;height:32px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    background: rgba(46,93,80,.10);
    border: 1px solid rgba(46,93,80,.14);
    font-weight:950;
    color:var(--agave);
    flex:0 0 auto;
  }
  .songResultsPanel{
    max-height:520px;
    overflow:auto;
    transition:max-height 220ms ease;
    -webkit-overflow-scrolling:touch;
  }
  .songResultsWrap.collapsed .songResultsPanel{ max-height:0px; overflow:hidden; }

  .results{ padding:10px; display:grid; gap:10px; }

  .result{
    display:flex;
    gap:12px;
    align-items:center;
    background: rgba(255,255,255,.75);
    border:1px solid rgba(199,169,107,.22);
    border-radius:18px;
    padding:10px 10px;
    cursor:pointer;
    user-select:none;
    min-width:0;
    overflow:hidden;
  }
  .cover{
    width:54px;height:54px;border-radius:14px;object-fit:cover;
    background: linear-gradient(180deg, rgba(46,93,80,.18), rgba(199,169,107,.18));
    box-shadow:0 12px 24px rgba(0,0,0,.10);
    flex:0 0 auto;
  }
  .rmeta{ flex:1; min-width:0; }
  .rtitle,.rartist{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .rtitle{ font-weight:950; font-size:14px; }
  .rartist{ margin-top:2px; font-size:12px; opacity:.75; font-weight:750; }

  .pick{
    flex:0 0 auto;
    font-weight:950;
    color:var(--agave);
    padding:10px 12px;
    border-radius:14px;
    background: rgba(46,93,80,.10);
    border: 1px solid rgba(46,93,80,.16);
    white-space:nowrap;
  }
  .pickDanger{
    background: rgba(0,0,0,.06);
    border: 1px solid rgba(0,0,0,.08);
    color: rgba(0,0,0,.65);
  }

  /* ===== CHOSEN (FIX: allow wrap, never explode) ===== */
  .chosen{
    margin-top:12px;
    border-radius:20px;
    border:1px solid rgba(46,93,80,.12);
    background: rgba(255,255,255,.75);
    padding:12px 12px;
    display:none;
    gap:12px;
    align-items:center;
    min-width:0;
    overflow:hidden;

    flex-wrap: wrap;          /* <<< KEY FIX */
  }
  .chosen .cover{ width:62px;height:62px; flex:0 0 auto; }

  .chosenMeta{
    flex: 1 1 220px;          /* allows shrinking */
    min-width: 0;             /* required for ellipsis */
  }
  .chosenMeta .t,.chosenMeta .a,.chosenMeta .i{
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .chosenMeta .t{ font-weight:950; font-size:15px; }
  .chosenMeta .a{ margin-top:2px; font-size:12px; opacity:.75; font-weight:800; }
  .chosenMeta .i{ margin-top:2px; font-size:12px; opacity:.65; font-weight:800; }

  .chosenRight{
    display:flex;
    gap:10px;
    align-items:center;
    flex: 0 0 auto;
  }

  /* On very small widths, move buttons to their own row aligned right */
  @media (max-width: 420px){
    .chosenRight{
      width: 100%;
      justify-content: flex-end;
    }
  }

  .footerRow{ margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }

  .toast{
    margin-top:14px;
    padding:12px 12px;
    border-radius:16px;
    background: rgba(46,93,80,.10);
    border: 1px solid rgba(46,93,80,.14);
    color: var(--agave);
    font-weight:850;
    display:none;
  }

  .preview{
    margin-top:14px;
    border-radius:26px;
    overflow:hidden;
    border:1px solid rgba(46,93,80,.12);
    box-shadow:0 18px 42px rgba(0,0,0,.08);
    background:white;
  }
  .preview .pimg{
    height:260px;
    background: linear-gradient(180deg, rgba(46,93,80,.12), rgba(199,169,107,.12));
    display:flex;align-items:center;justify-content:center;
    overflow:hidden;
  }
  .preview .pimg img{ width:100%;height:100%;object-fit:cover; display:block; }
  .preview .pbody{ padding:14px 14px 16px; }
  .preview .pname{ font-weight:950; color:var(--agave); font-size:18px; }
  .preview .pplace{ opacity:.7; font-weight:850; font-size:12px; margin-top:2px; }
  .preview .ptext{ margin-top:10px; white-space:pre-wrap; line-height:1.35; }
</style>
</head>

<body>
<div class="wrap">
  <div class="hero">
    <h1 class="title">GÃ¤stebuch-Eintrag</h1>
    <p class="sub">Demo-Modus: Es wird nichts gespeichert. Du siehst nur eine Vorschau und kannst die Song-Suche testen.</p>

    <div class="grid">
      <div class="row2">
        <div class="field">
          <label for="name">Name</label>
          <input id="name" autocomplete="name" placeholder="z.B. Anna" />
        </div>
        <div class="field">
          <label for="place">Wohnort</label>
          <input id="place" autocomplete="address-level2" placeholder="z.B. Frankfurt" />
        </div>
      </div>

      <div class="field">
        <label for="text">Text zur freien VerfÃ¼gung</label>
        <textarea id="text" placeholder="Schreib was Nettes (oder Lustiges) ðŸ˜Š"></textarea>
      </div>

      <div class="field">
        <label for="kacki">Wie war dein Kacki heute? ðŸ’©</label>
        <input id="kacki" placeholder="z.B. stabil / wild / kritisch / 10/10" />
        <div class="hint">NatÃ¼rlich nur als SpaÃŸ â€” du kannst auch einfach â€žKeine Angabeâ€œ schreiben ðŸ˜„</div>
      </div>

      <div class="field">
        <label>Foto (Demo)</label>
        <div class="songBox">
          <input id="photo" class="songSearch" placeholder="Bild-URL (optional) z.B. https://â€¦" />
          <button class="btn btnGhost" id="randomPhoto" type="button">Zufallsfoto</button>
          <button class="btn" id="selfieBtn" type="button">Selfie</button>
        </div>
        <input type="file" id="cameraInput" accept="image/*" capture="user" style="display:none">
        <div class="hint">Selfie Ã¶ffnet die Frontkamera. (Speichern/Upload bauen wir spÃ¤ter.)</div>
      </div>

      <div class="field">
        <label>Lieblingssong (Apple Music / iTunes Suche)</label>
        <div class="songBox">
          <input id="songQuery" class="songSearch" placeholder="" autocomplete="off" />
          <button class="btn" id="songSearchBtn" type="button">Suchen</button>
        </div>
        <div class="hint">Suchbegriff eingeben â†’ Treffer antippen â†’ wird Ã¼bernommen (danach klappt die Liste ein).</div>

        <div class="songResultsWrap" id="songResultsWrap" style="display:none;">
          <div class="songResultsHeader" id="songResultsHeader">
            <div class="hTitle" id="songHeaderTitle">Suchergebnisse</div>
            <div class="chev" id="songChev">âŒƒ</div>
          </div>
          <div class="songResultsPanel">
            <div class="results" id="results"></div>
          </div>
        </div>

        <div class="chosen" id="chosen">
          <img class="cover" id="chosenCover" alt="">
          <div class="chosenMeta">
            <div class="t" id="chosenTitle">â€”</div>
            <div class="a" id="chosenArtist">â€”</div>
            <div class="i" id="chosenInfo">â€”</div>
          </div>
          <div class="chosenRight">
            <a class="pick" id="chosenOpen" href="#" target="_blank" rel="noopener">Ã–ffnen</a>
            <button class="pick pickDanger" id="chosenClear" type="button">X</button>
          </div>
        </div>
      </div>

      <div class="footerRow">
        <button class="btn" id="submit" type="button">Eintrag (Demo) absenden</button>
        <button class="btn btnGhost" id="toWall" type="button">Zur Swipe-Ansicht</button>
      </div>

      <div class="toast" id="toast">Demo: â€žAbsendenâ€œ gedrÃ¼ckt (nichts gespeichert).</div>

      <div class="preview" id="preview">
        <div class="pimg" id="pimg">
          <div style="opacity:.75;font-weight:900;color:var(--agave);">Vorschau-Foto</div>
        </div>
        <div class="pbody">
          <div class="pname" id="pname">â€”</div>
          <div class="pplace" id="pplace">â€”</div>
          <div class="ptext" id="ptext">â€”</div>
          <div class="hint" id="pkacki" style="margin-top:10px;font-weight:900;">â€”</div>
          <div class="hint" id="psong" style="margin-top:8px;">â€”</div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  const WALL_URL = "guestbook-wall.html";
  const DEFAULT_PHOTO = "https://picsum.photos/1200/1600?random=80";

  const elName = document.getElementById('name');
  const elPlace = document.getElementById('place');
  const elText = document.getElementById('text');
  const elKacki = document.getElementById('kacki');
  const elPhoto = document.getElementById('photo');

  const elSongQuery = document.getElementById('songQuery');
  const elResults = document.getElementById('results');

  const songResultsWrap = document.getElementById('songResultsWrap');
  const songResultsHeader = document.getElementById('songResultsHeader');
  const songHeaderTitle = document.getElementById('songHeaderTitle');
  const songChev = document.getElementById('songChev');

  const chosen = document.getElementById('chosen');
  const chosenCover = document.getElementById('chosenCover');
  const chosenTitle = document.getElementById('chosenTitle');
  const chosenArtist = document.getElementById('chosenArtist');
  const chosenInfo = document.getElementById('chosenInfo');
  const chosenOpen = document.getElementById('chosenOpen');
  const chosenClear = document.getElementById('chosenClear');

  const toast = document.getElementById('toast');

  const pimg = document.getElementById('pimg');
  const pname = document.getElementById('pname');
  const pplace = document.getElementById('pplace');
  const ptext = document.getElementById('ptext');
  const pkacki = document.getElementById('pkacki');
  const psong = document.getElementById('psong');

  const cameraInput = document.getElementById('cameraInput');
  const selfieBtn = document.getElementById('selfieBtn');

  let selectedSong = null;
  let lastSearchItems = [];
  let collapsed = false;

  function setPreview(){
    const n = elName.value.trim() || "â€”";
    const p = elPlace.value.trim() || "â€”";
    const t = elText.value.trim() || "â€”";
    const k = elKacki.value.trim() || "â€”";
    const photoUrl = elPhoto.value.trim();

    pname.textContent = n;
    pplace.textContent = p;
    ptext.textContent = t;
    pkacki.textContent = "Wie war dein Kacki heute? " + (k || "â€”");

    psong.textContent = selectedSong
      ? ("Lieblingssong: " + selectedSong.trackName + " â€“ " + selectedSong.artistName)
      : "Lieblingssong: â€”";

    if (photoUrl){
      pimg.innerHTML = `<img src="${photoUrl}" alt="">`;
    } else {
      pimg.innerHTML = `<div style="opacity:.75;font-weight:900;color:var(--agave);">Vorschau-Foto</div>`;
    }
  }

  function showToast(){
    toast.style.display = "block";
    setTimeout(() => toast.style.display = "none", 2200);
  }

  function showChosen(song){
    selectedSong = song;
    chosen.style.display = "flex";
    chosenCover.src = song.artworkUrl || "";
    chosenTitle.textContent = song.trackName || "â€”";
    chosenArtist.textContent = song.artistName || "â€”";
    chosenInfo.textContent = "Track-ID: " + (song.trackId || "â€”");
    chosenOpen.href = song.trackViewUrl || "#";
    setPreview();
  }

  function clearChosen(){
    selectedSong = null;
    chosen.style.display = "none";
    chosenCover.removeAttribute('src');
    setPreview();
  }

  function setCollapsed(v){
    collapsed = v;
    songResultsWrap.classList.toggle('collapsed', collapsed);
    songChev.textContent = collapsed ? "âŒ„" : "âŒƒ";
  }

  async function searchSongs(q){
    elResults.innerHTML = "";
    lastSearchItems = [];
    songResultsWrap.style.display = "none";

    if (!q || q.trim().length < 2) {
      songResultsWrap.style.display = "block";
      songHeaderTitle.textContent = "Bitte mindestens 2 Zeichen";
      elResults.innerHTML = `<div class="hint" style="padding:10px;">Bitte mindestens 2 Zeichen eingeben.</div>`;
      setCollapsed(false);
      return;
    }

    const url = `https://itunes.apple.com/search?term=${encodeURIComponent(q)}&entity=song&limit=8&country=DE`;

    try{
      const res = await fetch(url);
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      const items = (data.results || []).filter(r => r.wrapperType === "track");
      lastSearchItems = items;

      songResultsWrap.style.display = "block";
      songHeaderTitle.textContent = `Suchergebnisse (${items.length})`;
      setCollapsed(false);

      if (!items.length){
        elResults.innerHTML = `<div class="hint" style="padding:10px;">Keine Treffer gefunden.</div>`;
        return;
      }

      elResults.innerHTML = items.map((r, i) => {
        const cover = (r.artworkUrl100 || "").replace("100x100","200x200");
        const title = (r.trackName || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
        const artist = (r.artistName || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
        return `
          <div class="result" data-idx="${i}">
            <img class="cover" src="${cover}" alt="">
            <div class="rmeta">
              <div class="rtitle">${title}</div>
              <div class="rartist">${artist}</div>
            </div>
            <div class="pick">WÃ¤hlen</div>
          </div>
        `;
      }).join("");

    }catch(e){
      songResultsWrap.style.display = "block";
      songHeaderTitle.textContent = "Suche fehlgeschlagen";
      elResults.innerHTML = `<div class="hint" style="padding:10px;">Suche fehlgeschlagen (z.B. kein Internet). In Demo egal ðŸ™‚</div>`;
      setCollapsed(false);
    }
  }

  elResults.addEventListener('pointerdown', (e) => {
    const row = e.target.closest('.result');
    if (!row) return;
    e.preventDefault();
  }, { passive:false });

  elResults.addEventListener('click', (ev) => {
    const row = ev.target.closest('.result');
    if (!row) return;

    const i = Number(row.getAttribute('data-idx'));
    const r = lastSearchItems[i];
    if (!r) return;

    showChosen({
      trackId: r.trackId,
      trackName: r.trackName,
      artistName: r.artistName,
      artworkUrl: (r.artworkUrl100 || "").replace("100x100","600x600"),
      trackViewUrl: r.trackViewUrl
    });

    setCollapsed(true);
  });

  songResultsHeader.addEventListener('click', () => setCollapsed(!collapsed));

  document.getElementById('songSearchBtn').addEventListener('click', () => searchSongs(elSongQuery.value));
  elSongQuery.addEventListener('keydown', (e) => {
    if (e.key === "Enter"){
      e.preventDefault();
      searchSongs(elSongQuery.value);
    }
  });

  chosenClear.addEventListener('click', () => { clearChosen(); setCollapsed(false); });

  document.getElementById('randomPhoto').addEventListener('click', () => {
    elPhoto.value = "https://picsum.photos/1200/1600?random=" + Math.floor(Math.random()*1000);
    setPreview();
  });

  selfieBtn.addEventListener('click', () => cameraInput.click());
  cameraInput.addEventListener('change', () => {
    const file = cameraInput.files && cameraInput.files[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    elPhoto.value = url;
    setPreview();
  });

  document.getElementById('submit').addEventListener('click', () => {
    showToast();
    console.log("DEMO payload:", {
      name: elName.value.trim(),
      place: elPlace.value.trim(),
      text: elText.value.trim(),
      kacki: elKacki.value.trim(),
      photo: elPhoto.value.trim() || DEFAULT_PHOTO,
      appleTrackId: selectedSong?.trackId || null,
      appleTrackUrl: selectedSong?.trackViewUrl || null,
      created: Date.now()
    });
  });

  document.getElementById('toWall').addEventListener('click', () => location.href = WALL_URL);

  [elName, elPlace, elText, elKacki, elPhoto].forEach(el => el.addEventListener('input', setPreview));
  setPreview();
</script>
</body>
</html>
